<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NGUI Demo</title>
  <!-- Tailwind CSS CDN -->
  <script src="ngui/3p/tailwind/tailwind.js"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- jQuery UI -->
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

  <!-- Fancytree -->
  <link href="ngui/3p/fancytree/ui.fancytree.min.css" rel="stylesheet" />
  <script src="ngui/3p/fancytree/jquery.fancytree-all-deps.min.js"></script>

  <link href="ngui/NGUI.css" rel="stylesheet"> 
  <!-- NGUI Scripts -->
  <script src="ngui/NGUIConnection.js"></script>
  <script src="ngui/NGUIModalTailwind.js"></script>
  <script src="ngui/NGUIWindowTailwind.js"></script>
  <script src="ngui/NGUITree.js"></script>


  <style>
    /* Grundlegendes Layout und Schriftfamilie für die gesamte Seite */
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      overflow-y: hidden;
    }

  #logOutput tr:nth-child(odd) {
    background-color: #f8fafc; /* sehr helles grau */
  }
  #logOutput tr:nth-child(even) {
    background-color: #fff;
  }    
  #logOutput tr:nth-child(odd) {
    background-color: #f8fafc;
  }
  #logOutput tr:nth-child(even) {
    background-color: #fff;
  }
  #logOutput tr:hover {
    background-color: #e0f2fe !important; /* zartes hellblau, überschreibt Tailwind */
  }  

table thead {
  position: sticky;
  top: 0; /* oder top: 56px; wenn Toolbar 56px hoch */
  z-index: 15;
  background: #e5e7eb;
}
table thead th {
  border-top: none !important;
}

#logOutput, #logOutput tr, #logOutput td {
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
  </style>
</head>

<body>

  <div id="bereich2">

    <div class="flex border-b text-xs text-gray-500 bg-gray-50">
      <button class="px-3 py-2 border-b-2 border-blue-500 text-blue-600">Datapoints</button>
      <button class="px-3 py-2 hover:text-blue-600">Datapoint Types</button>
    </div>

    <!-- Controls -->
<!-- Controls -->
<div class="flex justify-between items-center bg-gray-100 px-4 py-2 border-b text-xs flex-wrap gap-2">
  <div id="dpCreateBar" class="flex ... bg-gray-100 ..." style="position: sticky; top: 0; z-index: 20;">

    <!-- ...dein bisheriger Inhalt... -->
    <!-- Datenpunkt anlegen -->
    <form id="dpCreateForm" class="flex gap-2 items-center flex-wrap bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">
      <span class="font-semibold text-gray-700">Neuer Datenpunkt:</span>
      <input type="text" id="dpName" placeholder="Name" required
        class="px-2 py-1 border rounded text-xs w-28" autocomplete="off">
      <select id="dpType" class="px-2 py-1 border rounded text-xs bg-white" required>
        <option value="STRING">STRING</option>
        <option value="NUMBER">NUMBER</option>
        <option value="BOOLEAN">BOOLEAN</option>
      </select>
      <button class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">Anlegen</button>
      <span class="mx-2 text-gray-400">|</span>
      <span class="font-semibold text-gray-700">Massenanlage:</span>
      <input type="number" id="dpBulkCount" min="2" max="1000" value="10"
        class="px-2 py-1 border rounded text-xs w-16" title="Wie viele?">
      <input type="text" id="dpBulkPattern" placeholder="z.B. myDp_[NUM]_postfix"
        class="px-2 py-1 border rounded text-xs w-40" autocomplete="off">
      <select id="dpBulkType" class="px-2 py-1 border rounded text-xs bg-white" required>
        <option value="STRING">STRING</option>
        <option value="NUMBER">NUMBER</option>
        <option value="BOOLEAN">BOOLEAN</option>
      </select>
      <button type="button" id="dpBulkBtn" class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">Massenanlage</button>
    </form>
    <!-- Mülltonnen-Icon rechts oben -->
    <button id="deleteBtn"
      class="p-1 rounded hover:bg-red-100 ml-2"
      style="display:none; z-index:30;"
      title="Ausgewählte Datenpunkte löschen">
      <!-- Heroicons Trash SVG -->
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M1 7h22M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2" />
      </svg>
    </button>
  </div>
</div>

    <!-- Log Table -->
<div style="height: calc(100vh - 96px); overflow-y: auto;">
  <table class="min-w-full text-xs font-mono text-left table-auto border border-gray-300 border-collapse">
    <thead class="bg-gray-200 text-gray-600 uppercase" style="position: sticky; top: 0; z-index: 15;">

          <tr>
            <th class="px-4 py-2 border border-gray-300">
              DpName<br>
              <input type="text" id="filterDpName" class="w-full px-1 py-0.5 border rounded text-xs" placeholder="Filter...">
            </th>
            <th class="px-4 py-2 border border-gray-300">
              DpType<br>
              <input type="text" id="filterDpType" class="w-full px-1 py-0.5 border rounded text-xs" placeholder="Filter...">
            </th>
            <th class="px-4 py-2 border border-gray-300">
              Value<br>
              <input type="text" id="filterValue" class="w-full px-1 py-0.5 border rounded text-xs" placeholder="Filter...">
            </th>
            <th class="px-4 py-2 border border-gray-300">
              timestamp<br>
              <input type="text" id="filterTsFrom" class="w-20 px-1 py-0.5 border rounded text-xs" placeholder="von">
              <input type="text" id="filterTsTo" class="w-20 px-1 py-0.5 border rounded text-xs" placeholder="bis">
            </th>
            <th class="px-4 py-2 border border-gray-300">Config</th>
          </tr>
        </thead>
        <tbody id="logOutput" class="bg-white odd:bg-gray-50 even:bg-white">

        </tbody>
      </table>
    </div>
  </div>


  <script>
// Selektions-Logik für Tabellenzeilen

let selectedRows = new Set();
let lastSelectedIndex = null;
let isMouseDown = false;
let mouseSelectStart = null;

function updateSelection() {
  // Finde alle markierten Zeilen und extrahiere die DpNames
  const dpNames = Array.from(selectedRows).map(tr => tr.getAttribute('data-dpname'));
  // Callback
  if (typeof OnSelectionChanged === "function") {
    OnSelectionChanged(dpNames);
  }
}

// Markierungsfarbe per CSS
const style = document.createElement('style');
style.innerHTML = `
  tr.selected-row {
    background-color: #dbeafe !important; /* noch zarteres blau */
  }
`;
document.head.appendChild(style);

// Selektions-Events nach dem Rendern der Tabelle:
function enableRowSelection() {
  const rows = Array.from(document.querySelectorAll('#logOutput tr'));
  rows.forEach((tr, idx) => {
    tr.setAttribute('data-row-index', idx); // für Shift-Range
    // DpName als Attribut (anpassen falls anders)
    if (!tr.hasAttribute('data-dpname')) {
      const dpName = tr.querySelector('td')?.innerText?.trim();
      tr.setAttribute('data-dpname', dpName);
    }

    // Mouse Down: Start Selektion
    tr.addEventListener('mousedown', function (e) {
      isMouseDown = true;
      mouseSelectStart = idx;
      if (e.ctrlKey || e.metaKey) {
        // Toggle Einzelzeile
        if (selectedRows.has(tr)) {
          selectedRows.delete(tr);
          tr.classList.remove('selected-row');
        } else {
          selectedRows.add(tr);
          tr.classList.add('selected-row');
        }
        lastSelectedIndex = idx;
        updateSelection();
      } else if (e.shiftKey && lastSelectedIndex !== null) {
        // Range-Select
        const [start, end] = [lastSelectedIndex, idx].sort((a, b) => a - b);
        rows.forEach((row, i) => {
          if (i >= start && i <= end) {
            selectedRows.add(row);
            row.classList.add('selected-row');
          }
        });
        updateSelection();
      } else {
        // Nur diese Zeile selektieren
        selectedRows.forEach(row => row.classList.remove('selected-row'));
        selectedRows.clear();
        selectedRows.add(tr);
        tr.classList.add('selected-row');
        lastSelectedIndex = idx;
        updateSelection();
      }
    });

    // Mouse Over: Drag-Select
    tr.addEventListener('mouseenter', function (e) {
      if (isMouseDown && mouseSelectStart !== null && e.buttons === 1) {
        const [start, end] = [mouseSelectStart, idx].sort((a, b) => a - b);
        selectedRows.forEach(row => row.classList.remove('selected-row'));
        selectedRows.clear();
        for (let i = start; i <= end; i++) {
          selectedRows.add(rows[i]);
          rows[i].classList.add('selected-row');
        }
        updateSelection();
      }
    });

    // Mouse Up: Ende Drag
    tr.addEventListener('mouseup', function () {
      isMouseDown = false;
      mouseSelectStart = null;
    });
  });

  // Mouse Up überall: Drag-Ende
  document.addEventListener('mouseup', function () {
    isMouseDown = false;
    mouseSelectStart = null;
  });
}

// Rufe enableRowSelection() nach jedem Rendern der Tabelle auf!

// Beispiel-Callback
function OnSelectionChanged(dpNames) {

  document.getElementById("deleteBtn").style.display = dpNames.length > 0 ? "block" : "none";
}

// Optional: Klick-Handler für das Löschen
// Im deleteBtn-Listener das NGUIModal verwenden:
document.getElementById("deleteBtn").addEventListener("click", async function() {
  const dpNames = Array.from(selectedRows).map(tr => tr.getAttribute('data-dpname'));
  if (!dpNames.length) return;

  // Modal-Confirm mit NGUIModal
  const modal = new NGUIModal(
    "Löschen bestätigen",
    `Möchtest du die ausgewählten ${dpNames.length} Datenpunkte wirklich löschen?`,
    MBYESNO,
    'bg-red-600'
  );
  const result = await modal.ShowAsync();
  if (result === "yes") {
    // TODO: Backend-Call zum Löschen
    console.log("Lösche:", dpNames);
    for (const dpName of dpNames) {
      await new Promise(resolve => {
        g_DB.DpDelete(dpName, (rcv) => {
          // Optional: Fehlerbehandlung pro Datenpunkt
          resolve();
        });
      });
    }
    g_DB.DpNames(null, "*", OnDpNames); // Tabelle neu laden

  }
});

document.getElementById("dpCreateForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const name = document.getElementById("dpName").value.trim();
  const type = document.getElementById("dpType").value.trim();
  if (!name) return;
  // Hier Backend-Call zum Anlegen eines Datenpunkts
  g_DB.DpCreate(name, type, (rcv) => {
    if (!rcv.err) {
      document.getElementById("dpName").value = "";
      g_DB.DpNames(null, "*", OnDpNames); // Tabelle neu laden
    } else {
      new NGUIModal(
        "Error",
        "" + (rcv.err || "Unbekannter Fehler"),
        MBOK,
        'bg-red-600'
      ).ShowAsync();
    }
  });
});

document.getElementById("dpBulkBtn").addEventListener("click", function() {
  const count = parseInt(document.getElementById("dpBulkCount").value, 10);
  const pattern = document.getElementById("dpBulkPattern").value.trim();
  const type = document.getElementById("dpBulkType").value;
  if (!pattern || isNaN(count) || count < 2) return;
  let created = 0;
  function createNext(i) {
    if (i > count) {
      g_DB.DpNames(null, "*", OnDpNames); // Tabelle neu laden
      return;
    }
    const name = pattern.replace(/\[NUM\]/gi, i);
    g_DB.DpCreate(name, type, (rcv) => {
      created++;
      createNext(i + 1);
    });
  }
  createNext(1);
});

function applyTableFilters() {
  const dpNameFilter = document.getElementById('filterDpName').value.toLowerCase();
  const dpTypeFilter = document.getElementById('filterDpType').value.toLowerCase();
  const valueFilter = document.getElementById('filterValue').value.toLowerCase();
  const tsFrom = document.getElementById('filterTsFrom').value;
  const tsTo = document.getElementById('filterTsTo').value;

  document.querySelectorAll('#logOutput tr').forEach(row => {
    const dpName = row.children[0]?.innerText?.toLowerCase() || "";
    const dpType = row.children[1]?.innerText?.toLowerCase() || "";
    const value = row.children[2]?.innerText?.toLowerCase() || "";
    const ts = row.children[3]?.innerText?.trim() || "";

    let show = true;
    if (dpNameFilter && !dpName.includes(dpNameFilter)) show = false;
    if (dpTypeFilter && !dpType.includes(dpTypeFilter)) show = false;
    if (valueFilter && !value.includes(valueFilter)) show = false;

    // Zeitfilter: Format YYYY-MM-DD HH:mm:ss.SSS
    if ((tsFrom || tsTo) && ts) {
      const tsDate = new Date(ts.replace(" ", "T"));
      if (tsFrom) {
        const fromDate = new Date(tsFrom.replace(" ", "T"));
        if (tsDate < fromDate) show = false;
      }
      if (tsTo) {
        const toDate = new Date(tsTo.replace(" ", "T"));
        if (tsDate > toDate) show = false;
      }
    }

    row.style.display = show ? "" : "none";
  });
}

// Filter-Events binden (einmalig nach DOMContentLoaded oder nach Rendern)
['filterDpName', 'filterDpType', 'filterValue', 'filterTsFrom', 'filterTsTo'].forEach(id => {
  document.getElementById(id).addEventListener('input', applyTableFilters);
});

    // filepath: d:\Data\git\NGUI\htdocs\NGUI_Browser.html
    // Resizable table columns
    document.addEventListener("DOMContentLoaded", function () {
      // Select the log table specifically to avoid errors if other tables exist without <th>
      const table = document.querySelector("table.min-w-full");
      if (!table) return; // Exit if the table is not found
      const ths = table.querySelectorAll("th");
      ths.forEach(function (th) {
        th.style.position = "relative";
        const resizer = document.createElement("div");
        resizer.style.width = "5px";
        resizer.style.height = "100%";
        resizer.style.position = "absolute";
        resizer.style.right = "0";
        resizer.style.top = "0";
        resizer.style.cursor = "col-resize";
        resizer.style.userSelect = "none";
        resizer.style.zIndex = "10";
        th.appendChild(resizer);

        let startX, startWidth;
        resizer.addEventListener("mousedown", function (e) {
          startX = e.pageX;
          startWidth = th.offsetWidth;
          document.documentElement.style.cursor = "col-resize";
          document.addEventListener("mousemove", mousemove);
          document.addEventListener("mouseup", mouseup);
          e.preventDefault();
        });

        function mousemove(e) {
          const newWidth = startWidth + (e.pageX - startX);
          th.style.width = newWidth + "px";
        }

        function mouseup() {
          document.documentElement.style.cursor = "";
          document.removeEventListener("mousemove", mousemove);
          document.removeEventListener("mouseup", mouseup);
        }
      });
    });


    var g_NGUI = new NGUIClient();
    g_NGUI.Connect("ws://localhost:2808", OnAppOpen);
    var g_DB = g_NGUI.GetDbClient();

    function OnDpConnect(rcv) {
      if (!rcv.cmd && rcv.data) {
        function updateValues(dpName, valueObj) {
          // valueObj kann ein Wert oder ein Objekt mit weiteren Feldern sein
          if (valueObj && typeof valueObj === "object" && !Array.isArray(valueObj)) {
            // Prüfe, ob das Objekt ein echtes Value-Objekt ist (mit value und tstamp)
            if ("value" in valueObj && "tstamp" in valueObj) {
              const valElem = document.getElementById("VALUE_" + dpName);
              const tsElem = document.getElementById("TS_" + dpName);
              if (valElem) valElem.innerHTML = valueObj.value;
              if (tsElem) {
              // valueObj.tstamp kann Zahl oder ISO-String sein
              let date;
              if (typeof valueObj.tstamp === "number") {
                // UNIX-Zeitstempel in Sekunden oder Millisekunden?
                date = valueObj.tstamp > 1e12
                ? new Date(valueObj.tstamp)
                : new Date(valueObj.tstamp * 1000);
              } else {
                date = new Date(valueObj.tstamp);
              }
              // Format: YYYY-MM-DD HH:mm:ss.SSS (lokale Zeit)
              const pad = n => n.toString().padStart(2, "0");
              const padMs = n => n.toString().padStart(3, "0");
              const formatted = 
                date.getFullYear() + "-" +
                pad(date.getMonth() + 1) + "-" +
                pad(date.getDate()) + " " +
                pad(date.getHours()) + ":" +
                pad(date.getMinutes()) + ":" +
                pad(date.getSeconds()) + "." +
                padMs(date.getMilliseconds());
              tsElem.innerHTML = formatted;
              }
            } else {
              // Sonst: Rekursiv für alle Keys
              for (const key in valueObj) {
                if (valueObj.hasOwnProperty(key)) {
                  updateValues(dpName + "." + key, valueObj[key]);
                }
              }
            }
          }
        }
        updateValues(rcv.data.dpName, rcv.data.value);
      }
    }

    const DpType = {
      STRING: 1,
      NUMBER: 2,
      BOOLEAN: 3,
      STRUCT: 4
    };

    const DpTypeReverse = {
      1: 'STRING',
      2: 'NUMBER',
      3: 'BOOLEAN',
      4: 'STRUCT'
    };

    const DpTypeForward = {
      STRING: 1,
      NUMBER: 2,
      BOOLEAN: 3,
      STRUCT: 4
    };

    function OnDpNames(rcv) {
      var html = "";

      // Rekursive Hilfsfunktion für den Baum
      function renderDp(dp, level, parentPath, parentId) {
        const fullPath = parentPath ? parentPath + "." + dp.DpName : dp.DpName;
        const rowId = "ROW_" + fullPath;
        const hasChildren = dp.children && dp.children.length > 0;
        const padding = 20 * level;
        let dpTypeText = `STRUCT (${dp.DpType})`;
        if (dp.valueType)
          dpTypeText = DpTypeReverse[dp.valueType];

        // Lucide chevron-right SVG
        const chevronRight = `<svg class="lucide lucide-chevron-right inline w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 18l6-6-6-6"/></svg>`;
        // Lucide chevron-down SVG
        const chevronDown = `<svg class="lucide lucide-chevron-down inline w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>`;

        const chevronCircle = `<svg class="lucide lucide-dot inline w-3 h-3 align-middle" fill="currentColor" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" /></svg>`;

        // Toggle-Button für Knoten mit Kindern
        let toggle = "";
        if (hasChildren) {
          toggle = `<span class="toggle-btn cursor-pointer select-none" data-target="${rowId}" data-state="closed">${chevronRight}</span>`;
        }
        else {
          toggle = `<span class="select-none"  data-state="closed">${chevronCircle}</span>`;
        }

        html += `<tr id="${rowId}" class="log-entry" data-level="DpName" data-parent="${parentId || ''}" style="${level > 0 ? 'display:none;' : ''}">
    <td class="border border-gray-300 px-4 py-1 text-black-500" style="padding-left:${padding}px;">
      ${toggle} ${dp.DpName}
    </td>
    <td class="border border-gray-300 px-4 py-1 text-green-500">${dpTypeText}</td>
    <td class="border border-gray-300 px-4 py-1" id="VALUE_${fullPath}"></td>
    <td class="border border-gray-300 px-4 py-1 text-gray-500" id="TS_${fullPath}"></td>
    <td class="border border-gray-300 px-4 py-1 text-gray-600 text-center">
      <!-- Lucide simple "sliders-horizontal" icon SVG -->
      <svg xmlns="http://www.w3.org/2000/svg"
         class="lucide lucide-sliders-horizontal inline w-5 h-5 cursor-pointer hover:text-blue-500"
         fill="none" viewBox="0 0 24 24" stroke="currentColor"
         onclick="OnDpSettings('${fullPath}')">
        <line x1="21" y1="6" x2="3" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="21" y1="12" x2="9" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="21" y1="18" x2="7" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <circle cx="6" cy="6" r="2" stroke="currentColor" stroke-width="2" fill="white"/>
        <circle cx="8" cy="12" r="2" stroke="currentColor" stroke-width="2" fill="white"/>
        <circle cx="6" cy="18" r="2" stroke="currentColor" stroke-width="2" fill="white"/>
      </svg>
    </td>
  </tr>`;

        if (!fullPath.includes('.')) {
          g_DB.DpConnect(fullPath, OnDpConnect);
        }

        if (hasChildren) {
          for (let i = 0; i < dp.children.length; i++) {
            renderDp(dp.children[i], level + 1, fullPath, rowId);
          }
        }
      }

      // ...nach dem Rendern...
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
          const targetRowId = btn.getAttribute('data-target');
          const isCollapsed = btn.getAttribute('data-state') === "closed";
          btn.innerHTML = isCollapsed ? `<svg class="lucide lucide-chevron-down inline w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>` : `<svg class="lucide lucide-chevron-right inline w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 18l6-6-6-6"/></svg>`;
          btn.setAttribute('data-state', isCollapsed ? "open" : "closed");
          toggleChildren(targetRowId, isCollapsed);
        });
      });

      // Starte für jeden Root-Knoten
      for (let i = 0; i < rcv.data.names.length; i++) {
        renderDp(rcv.data.names[i], 0, "", "");
      }

      document.getElementById("logOutput").innerHTML = html;


document.querySelectorAll('td[id^="VALUE_"]').forEach(td => {
  td.addEventListener('dblclick', function (e) {
    const oldValue = td.innerText;
    const dpName = td.id.substring("VALUE_".length);
    // Hole den dpType aus der Nachbarzelle (zweite Spalte im gleichen <tr>)
    const tr = td.parentElement;
    const dpType = tr.children[1]?.innerText?.trim();

    // Erstelle ein Eingabefeld
    const input = document.createElement('input');
    input.type = "text";
    input.value = oldValue;
    input.className = "w-full py-0.5 border rounded text-xs";
    input.style.boxSizing = "border-box";
    input.style.width = "100%";
    input.style.height = "100%";
    input.style.minWidth = "0";
    input.style.fontSize = "inherit";
    input.style.background = "inherit";
    input.style.margin = "0";
    input.style.padding = "0 2px";
    input.style.border = "none";
    input.style.outline = "none";
    input.style.boxShadow = "none";
    input.style.display = "block";
    td.innerHTML = "";
    td.appendChild(input);
    input.focus();
    input.select();

    // Callback-Handler
let finished = false;

function finishEdit(apply, tabPressed = false) {
  if (finished) return;
  finished = true;
  const newValue = input.value;
  // Wert NICHT direkt ins td schreiben, Backend liefert neuen Wert!
  if (apply && newValue !== oldValue) {
    if (typeof OnValueEdited === "function") {
      OnValueEdited(dpName, oldValue, newValue, dpType, td);
    }
  } else if (!apply) {
    td.innerHTML = oldValue; // Bei Abbruch alten Wert wiederherstellen
  }
  // Tab-Logik wie gehabt ...
  if (tabPressed) {
    let nextTr = tr.nextElementSibling;
    while (nextTr && !nextTr.querySelector('td[id^="VALUE_"]')) {
      nextTr = nextTr.nextElementSibling;
    }
    if (nextTr) {
      const nextTd = nextTr.querySelector('td[id^="VALUE_"]');
      if (nextTd) {
        setTimeout(() => nextTd.dispatchEvent(new Event('dblclick')), 0);
      }
    }
  }
}

    // Enter = übernehmen, Escape = abbrechen, Tab = übernehmen & nächstes Feld
    input.addEventListener('keydown', function (evt) {
      if (evt.key === "Enter") {
        finishEdit(true);
      } else if (evt.key === "Escape") {
        finishEdit(false);
      } else if (evt.key === "Tab") {
        evt.preventDefault();
        finishEdit(true, true);
      }
    });

    // Bei Fokusverlust übernehmen
    input.addEventListener('blur', function () {
      finishEdit(true);
    });
  });
});

      // Toggle-Logik
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
          const targetRowId = btn.getAttribute('data-target');
          const isCollapsed = btn.getAttribute('data-state') === "closed";
          // Lucide SVGs:
          const chevronRight = `<svg class="lucide lucide-chevron-right inline w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 18l6-6-6-6"/></svg>`;
          const chevronDown = `<svg class="lucide lucide-chevron-down inline w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"/></svg>`;
          btn.innerHTML = isCollapsed ? chevronDown : chevronRight;
          btn.setAttribute('data-state', isCollapsed ? "open" : "closed");
          toggleChildren(targetRowId, isCollapsed);
        });
      });

      function toggleChildren(parentId, show) {
        const rows = document.querySelectorAll(`tr[data-parent="${parentId}"]`);
        rows.forEach(row => {
          row.style.display = show ? "" : "none";
          // Wenn wir einklappen, klappen wir auch alle Kindknoten zu
          if (!show) {
            const toggle = row.querySelector('.toggle-btn');
            if (toggle) {
              // Lucide chevron-right SVG
              toggle.innerHTML = `<svg class="lucide lucide-chevron-right inline w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 18l6-6-6-6"/></svg>`;
              toggle.setAttribute('data-state', 'closed');
            }
            toggleChildren(row.id, false);
          }
        });
      }
      enableRowSelection()
    }


    function OnValueEdited(dpName, oldValue, newValue, dpType, td) {
      let type = DpTypeForward[dpType];
      let setVal = null;
      let prevVal = null;
      switch(type) {
        case DpType.STRING:
          setVal = newValue;
          break;
        case DpType.NUMBER:
          setVal = Number(newValue);
          break;
        case DpType.BOOLEAN:
          setVal = (newValue === "true" || newValue === "1" || newValue === 1 || newValue === true);
          break;
        default:
          setVal = newValue;
      }

      switch(type) {
        case DpType.STRING:
          prevVal = oldValue;
          break;
        case DpType.NUMBER:
          prevVal = Number(oldValue);
          break;
        case DpType.BOOLEAN:
          prevVal = (oldValue === "true" || oldValue === "1" || oldValue === 1 || oldValue === true);
          break;
        default:
          prevVal = oldValue;
      }      

      g_NGUI.GetDbClient().DpSet(dpName, setVal, (rcv) => 
      {
        if(!rcv.err)
        {
          td.innerHTML = setVal;
          console.log(rcv);
        }
        else
        {
          td.innerHTML = prevVal;
          console.log(rcv);
        }
      });
    }    

    function OnDpSettings(dpName)
    {
      console.log(dpName)
    }

function OnDpTypes(rcv) {
  // Erwartet: rcv.data = Array von Typen, z.B. ["STRING", "NUMBER", "BOOLEAN"]
  const select = document.getElementById("dpType");
  if (!select || !rcv.data) return;
  select.innerHTML = ""; // Vorherige Optionen entfernen
  rcv.data.types.forEach(type => {
    const opt = document.createElement("option");
    opt.value = type;
    opt.textContent = type;
    select.appendChild(opt);
  });
  // Optional: Auch für Massenanlage das gleiche Select aktualisieren
  const bulkSelect = document.getElementById("dpBulkType");
  if (bulkSelect) {
    bulkSelect.innerHTML = "";
    rcv.data.types.forEach(type => {
      const opt = document.createElement("option");
      opt.value = type;
      opt.textContent = type;
      bulkSelect.appendChild(opt);
    });
  }
}
    function OnAppOpen() {
      console.log("App opened");
      //g_NGUI.LoadPage("NGUI_DemoTop.html", "right-top", null);


      g_NGUI.GetDbClient().DpNames(null, "*", OnDpNames);
      g_NGUI.GetDbClient().DpTypes("*", OnDpTypes);
    }


  </script>
</body>

</html>